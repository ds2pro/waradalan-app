name: Expo AAB Builder (VPS)

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  PROJECT_DIR: /root/waradalan-app
  BUILD_DIR: /root/builds

jobs:
  build-aab:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üîñ Version bump and tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          npm run release
          git push origin main --follow-tags

      - name: üöÄ Remote AAB Build on VPS
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: root
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          timeout: 60m # Correct parameter name for SSH timeout
          command_timeout: 60m # Timeout for individual commands
          script: |
            set -e

            echo "üîß Setting up environment..."
            export ANDROID_HOME=$HOME/Android
            export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools

            echo "üìÇ Navigating to project..."
            cd $PROJECT_DIR

            echo "üßπ Cleaning workspace..."
            git reset --hard HEAD
            git clean -fd
            git pull origin main

            echo "üì¶ Installing dependencies..."
            npm ci --no-audit

            echo "üöÄ Building AAB (this may take 15-25 minutes)..."
            npx eas build --platform android \
              --profile production \
              --non-interactive \
              --no-wait \
              --local

            echo "üîÑ Waiting for build to complete..."
            sleep 60 # Initial buffer

            # Monitor build process
            while pgrep -f "gradlew" >/dev/null; do
              echo "‚è≥ Build still running..."
              sleep 30
            done

            echo "üì¶ Locating AAB file..."
            mkdir -p $BUILD_DIR
            AAB_PATH=$(find $PROJECT_DIR -name '*.aab' | head -n 1)

            if [ -f "$AAB_PATH" ]; then
              mv "$AAB_PATH" $BUILD_DIR/
              echo "‚úÖ AAB saved to $BUILD_DIR/$(basename $AAB_PATH)"
            else
              echo "‚ùå AAB not found! Build likely failed."
              find $PROJECT_DIR/android -name '*.log' -exec cat {} \;
              exit 1
            fi
