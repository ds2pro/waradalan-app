name: Expo CI/CD Pipeline (Local VPS Build with Version Bump)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-on-vps:
    name: 🏗️ Build Android AAB + Version Bump (if success)
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout repo
        uses: actions/checkout@v4

      - name: 🤝 SSH into VPS and build
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: root
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /root/waradalan-app

            echo "🧹 Cleaning previous build artifacts"
            rm -rf dist android/app/build /root/builds || true
            mkdir -p /root/builds

            echo "🚀 Building AAB"
            npx eas build --local --platform android --output=dist/app-release.aab

            AAB_FILE="dist/app-release.aab"

            if [ -f "$AAB_FILE" ]; then
              echo "✅ Build succeeded"
              mv "$AAB_FILE" /root/builds/

              echo "🔖 Running version bump"
              git config --global user.email "ci@github.com"
              git config --global user.name "CI Bot"

              git checkout main

              # Make sure working directory is clean
              git reset --hard
              git clean -fd

              # Bump version, generate changelog and tag
              npx standard-version --skip.commit --skip.tag

              # Commit and push
              git add .
              git commit -m "ci: version bump after successful build"
              git push origin main
            else
              echo "❌ Build failed — skipping version bump"
              exit 1
            fi
